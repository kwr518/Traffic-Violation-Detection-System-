<!DOCTYPE html>
<html>
<head>
    <title>êµí†µ ë²•ê·œ ìœ„ë°˜ ê´€ì œ ì‹œìŠ¤í…œ</title>
    <style>
        body { font-family: 'Malgun Gothic', sans-serif; padding: 40px; background-color: #f0f2f5; }
        .upload-section { background-color: #fff; padding: 25px; border-radius: 15px; margin-bottom: 30px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); border-left: 5px solid #1a73e8; }
        .card { border: 1px solid #ccc; padding: 20px; margin-bottom: 20px; border-radius: 15px; background-color: #fff; display: flex; gap: 25px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .video-box { flex: 1; }
        .info-box { flex: 1.5; }
        .plate-number { background-color: #f1f3f4; padding: 5px 10px; border-radius: 5px; font-weight: bold; font-size: 1.1em; border: 1px solid #ddd; color: #d93025; }
        button { padding: 10px 20px; background-color: #1a73e8; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; }
        button:hover { background-color: #1557b0; }
        #llm-response { margin-top: 15px; padding: 15px; background: #f8f9fa; border-radius: 8px; display: none; white-space: pre-wrap; line-height: 1.6; border: 1px solid #e0e0e0; }
        .status-dot { height: 10px; width: 10px; background-color: #34a853; border-radius: 50%; display: inline-block; margin-right: 5px; }
    </style>
</head>
<body>
    <h1 style="color: #1a73e8;">ì‹¤ì‹œê°„ ìœ„ë°˜ ê´€ì œ ì‹œìŠ¤í…œ</h1>
    
    <div style="margin-bottom: 20px; font-size: 0.9em; color: #666;">
        <span class="status-dot"></span> ìë°” ì„œë²„ ì—°ë™ ì¤‘ (localhost:8080)
    </div>

    <div class="upload-section">
        <h3 style="margin-top:0;">ğŸ¥ ë¶„ì„ ì˜ìƒ ì—…ë¡œë“œ</h3>
        <form action="/api/upload-video" method="post" enctype="multipart/form-data" style="display: flex; gap: 15px; align-items: center;">
            <input type="file" name="file" accept="video/mp4,video/*" required style="padding: 8px; border: 1px solid #ccc; border-radius: 5px; flex: 1;">
            <button type="submit">AI ë¶„ì„ ì‹œì‘</button>
        </form>
    </div>

    <div id="log-container"> <p id="placeholder">ìƒˆë¡œìš´ ìœ„ë°˜ ì´ë²¤íŠ¸ë¥¼ ê¸°ë‹¤ë¦¬ëŠ” ì¤‘ì…ë‹ˆë‹¤...</p> </div>

    <script>
        let lastCount = 0;
        async function checkNewLogs() {
            try {
                // ğŸ’¡ ìë°” ì„œë²„ì—ì„œ ë¡œê·¸ë¥¼ ê°€ì ¸ì˜¤ë„ë¡ í˜¸ì¶œ
                const res = await fetch('/api/logs');
                if (!res.ok) throw new Error('ë„¤íŠ¸ì›Œí¬ ì‘ë‹µ ì—ëŸ¬');
                
                const logs = await res.json();
                
                if (logs.length > lastCount) {
                    const container = document.getElementById('log-container');
                    const placeholder = document.getElementById('placeholder');
                    if (placeholder) placeholder.remove();

                    // ìµœì‹  ë¡œê·¸ê°€ ìœ„ë¡œ ì˜¤ë„ë¡ ì—­ìˆœ ì¶œë ¥
                    for (let i = lastCount; i < logs.length; i++) {
                        const data = logs[i];
                        const card = document.createElement('div');
                        card.className = 'card';
                        card.innerHTML = `
                            <div class="video-box">
                                <video width="320" height="240" controls crossorigin="anonymous" style="border-radius: 10px; background: #000;">
                                    <source src="${data.video_url}" type="video/mp4">
                                </video>
                            </div>
                            <div class="info-box">
                                <h3 style="margin-top: 0; color: #d93025;">ğŸš¦ ${data.result} ê°ì§€</h3>
                                <p><b>ì°¨ëŸ‰ë²ˆí˜¸:</b> <span class="plate-number">${data.plate || 'ì¸ì‹ ë¶ˆê°€ëŠ¥'}</span></p> 
                                <p><b>ê°ì§€ ì‹œê°„:</b> ${data.time || 'ì •ë³´ ì—†ìŒ'}</p>
                                <p style="font-size: 0.9em; color: #7f8c8d;">${data.location || 'ê´€ì œ êµ¬ì—­ A-1'}</p>
                            </div>
                        `;
                        container.prepend(card);
                    }
                    lastCount = logs.length;
                }
            } catch (e) { 
                console.error("Log fetch error:", e); 
            }
        }
        // 3ì´ˆë§ˆë‹¤ ìƒˆë¡œìš´ ìœ„ë°˜ ê¸°ë¡ í™•ì¸
        setInterval(checkNewLogs, 3000); 
    </script>

    <div class="upload-section" style="border-left: 5px solid #34a853; margin-top: 40px;">
        <h3 style="margin-top:0;">ğŸ¤– êµí†µë²•ê·œ AI ì „ë¬¸ê°€ ìƒë‹´</h3>
        <p style="font-size: 0.85em; color: #666; margin-bottom: 15px;">êµí†µë²•ê·œ ë° ë²”ì¹™ê¸ˆì— ëŒ€í•´ ë¬´ì—‡ì´ë“  ë¬¼ì–´ë³´ì„¸ìš”.</p>
        <div style="display: flex; gap: 10px;">
            <input type="text" id="user-question" placeholder="ì˜ˆ: ì¤‘ì•™ì„  ì¹¨ë²” ë²Œê¸ˆ ì–¼ë§ˆì•¼?" 
                   style="padding: 12px; border: 1px solid #ccc; border-radius: 8px; flex: 1;"
                   onkeypress="if(event.keyCode==13) askLLM()">
            <button onclick="askLLM()" id="ask-btn" style="background-color: #34a853;">ì§ˆë¬¸í•˜ê¸°</button>
        </div>
        <div id="llm-response"></div>
    </div>

    <script>
        async function askLLM() {
            const questionInput = document.getElementById('user-question');
            const question = questionInput.value;
            const responseBox = document.getElementById('llm-response');
            const btn = document.getElementById('ask-btn');

            if (!question) return alert("ì§ˆë¬¸ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.");

            btn.disabled = true;
            btn.innerText = "ë¶„ì„ ì¤‘...";
            responseBox.style.display = "block";
            responseBox.innerHTML = "â³ <b>AIê°€ ë²•ê·œ ë°ì´í„°ë¥¼ í™•ì¸ ì¤‘ì…ë‹ˆë‹¤...</b>";

            try {
                // ğŸ’¡ ìë°” ì„œë²„ì˜ ì±—ë´‡ ì—°ë™ ì£¼ì†Œ í˜¸ì¶œ
                const res = await fetch('/api/ask-chatbot', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ question: question })
                });

                const data = await res.json();
                
                let answerText = "";
                if (data && data.answer) {
                    answerText = data.answer;
                } else {
                    answerText = "ë‹µë³€ì„ ê°€ì ¸ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.";
                }

                responseBox.innerHTML = `<b>ğŸ¤– AI ë‹µë³€:</b><br>${answerText.replace(/\n/g, '<br>')}`;
                questionInput.value = ""; // ì…ë ¥ì°½ ì´ˆê¸°í™”
            } catch (e) {
                responseBox.innerHTML = "âŒ <b>ì„œë²„ ì—°ê²° ì‹¤íŒ¨</b><br>ìë°” ì„œë²„(8080)ê°€ ì¼œì ¸ ìˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”.";
            } finally {
                btn.disabled = false;
                btn.innerText = "ì§ˆë¬¸í•˜ê¸°";
            }
        }
    </script>
</body>
</html>